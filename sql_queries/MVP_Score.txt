 WITH Team_Table AS (
  SELECT
    team_id,
    name,
    season,
    tournament,
    (
      SUM(points) * 0.2 +               -- w9 for Team Points
      SUM(assists) * 0.15 +             -- w10 for Team Assists
      SUM(team_rebounds) * 0.15 +      -- w11 for Team Rebounds
      SUM(steals) * 0.1 +               -- w12 for Team Steals
      SUM(blocks) * 0.1 -               -- w13 for Team Blocks
      SUM(turnovers) * -0.1 -           -- w14 for Team Turnovers
      SUM(personal_fouls) * -0.1 -      -- w15 for Team Personal Fouls
      SUM(team_tech_fouls) * -0.05      -- w16 for Team Technical Fouls
    ) / COUNT(DISTINCT game_id) AS team_contribution
  FROM
    `bigquery-public-data.ncaa_basketball.mbb_teams_games_sr`
  WHERE
    season = 2016
AND
    tournament = 'NCAA'
  GROUP BY
    name,
    team_id,
    season,
    tournament
),

Team_Weight_Ratio AS (
SELECT
  team_id,
  name,
  season,
  tournament,
  team_contribution
FROM
  Team_Table
ORDER BY
  team_contribution DESC),


Player_Table AS
(SELECT
season,tournament,full_name,
0.3*SUM(points)+
0.2*SUM(blocks)+
0.1*SUM(steals)+
-0.1*SUM(turnovers)+
0.2*SUM(assists)+
0.2*SUM(rebounds)+
-0.1*SUM(personal_fouls)+
-0.05*SUM(tech_fouls) AS weights,
COUNT(game_id) AS games_played, team_name
FROM `bigquery-public-data.ncaa_basketball.mbb_players_games_sr`
where season = 2016 AND tournament = 'NCAA'
group by season,tournament,full_name, team_name
order by full_name),


Player_Weight_Tables AS(
SELECT full_name,weights/games_played AS player_weights_ratio,team_name FROM Player_Table
order by player_weights_ratio DESC
)

Select ROUND(P1.player_weights_ratio+T1.team_contribution,2) AS Final_Ratio, P1.full_name, P1.player_weights_ratio, T1.team_contribution,T1.team_id, T1.name,  from
Player_Weight_Tables P1
INNER JOIN
Team_Weight_Ratio T1
ON P1.team_name = T1.name
order by Final_Ratio DESC
LIMIT 50;



